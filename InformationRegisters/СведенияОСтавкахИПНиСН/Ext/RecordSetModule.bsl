#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ 

Процедура ПриЗаписи(Отказ, Замещение)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТаблицаДокументов",	Выгрузить(, "ВидСтавокИПНиСН, Период, СуммаДоходаПо, СуммаДоходаС, СуммаНалогаПредыдущегоПредела"));
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаДокументов.ВидСтавокИПНиСН КАК ВидСтавокИПНиСН,
	|	ТаблицаДокументов.Период КАК Период,
	|	ТаблицаДокументов.СуммаДоходаПо КАК СуммаДоходаПо,
	|	ТаблицаДокументов.СуммаДоходаС,
	|	ТаблицаДокументов.СуммаНалогаПредыдущегоПредела
	|ПОМЕСТИТЬ ВТ_Документы
	|ИЗ
	|	&ТаблицаДокументов КАК ТаблицаДокументов
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ВидСтавокИПНиСН,
	|	Период
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СведенияОСтавкахИПНиСН.НомерСтрокиСтавок,
	|	СведенияОСтавкахИПНиСН.СуммаДоходаС,
	|	СведенияОСтавкахИПНиСН.СуммаДоходаПо КАК СуммаДоходаПо,
	|	СведенияОСтавкахИПНиСН.СуммаНалогаПредыдущегоПредела,
	|	СведенияОСтавкахИПНиСН.Ставка,
	|	ДокументыСрез.ВидСтавокИПНиСН,
	|	ДокументыСрез.Период
	|ИЗ
	|	РегистрСведений.СведенияОСтавкахИПНиСН КАК СведенияОСтавкахИПНиСН
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Документы КАК ДокументыСрез
	|		ПО СведенияОСтавкахИПНиСН.ВидСтавокИПНиСН = ДокументыСрез.ВидСтавокИПНиСН
	|			И СведенияОСтавкахИПНиСН.Период = ДокументыСрез.Период";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ПредыдущийПредел = 0;
	ПредыдущаяСтрока = Неопределено;	

	Пока Выборка.Следующий() Цикл
		
		Если Выборка.НомерСтрокиСтавок = 1 И Выборка.СуммаДоходаС <> 0 Тогда
			ТекстСообщения = НСтр("ru='Нижний предел по первой строке должен быть нулевым'");
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, , "ЭтотОбъект", ,Отказ);
		КонецЕсли;
		
		Если ПредыдущийПредел <> Выборка.СуммаДоходаС Тогда
			ТекстСообщения = НСтр("ru='В строке "+Выборка.НомерСтрокиСтавок+" нижний предел не совпадает с верхним пределом предыдущей строки'");
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, , "ЭтотОбъект", ,Отказ);
		КонецЕсли;
		
		Если Выборка.СуммаДоходаС >= Выборка.СуммаДоходаПо Тогда
			ТекстСообщения = НСтр("ru='В строке "+Выборка.НомерСтрокиСтавок+" верхний предел должен быть больше нижнего'");
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, , "ЭтотОбъект", ,Отказ);
		КонецЕсли;
		
		// запомним для следующей итерации
		ПредыдущийПредел = Выборка.СуммаДоходаПо;
		ПредыдущаяСтрока = Выборка;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецЕсли
